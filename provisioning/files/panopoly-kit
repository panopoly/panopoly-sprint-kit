#!/usr/bin/env bash

echo "Welcome to the Panopoly Sprint Kit"

PANOPOLY_HOME=$HOME/Desktop/panopoly

# Setup Panopoly source code.
if ! [ -d "$PANOPOLY_HOME" ]; then
	git clone --branch 7.x-1.x http://git.drupal.org/project/panopoly.git $PANOPOLY_HOME

	# Create build.properties.
	cat > $PANOPOLY_HOME/build.properties << "EOF"
# Automatically generated by 'panopoly-kit'
build.mode = dev
build.core.dir = /var/www/panopoly-kit
drush.site-install.db_url = mysqli://panopoly:panopoly@localhost/panopoly
test.behat.base_url = http://panopoly-kit.dev/
EOF

	# TODO: Remove this once Issue #2509166 is committed.
	PANOPOLY_PHING_PATCH=https://www.drupal.org/files/issues/panopoly-phing-2509166-8.patch
	MYTMPDIR=$(mktemp -dt panopoly-kit-XXX)
	mkdir $MYTMPDIR
	wget $PANOPOLY_PHING_PATCH -O $MYTMPDIR/issue2509166.patch
	(cd $PANOPOLY_HOME && patch -p1 < $MYTMPDIR/issue2509166.patch)
	rm -rf $MYTMPDIR

	# Install all our build dependencies with composer.
	ln -s $PANOPOLY_HOME/composer.json $HOME/
	ln -s $PANOPOLY_HOME/composer.lock $HOME/
	composer install -d $HOME

	# Build, install, and get all dependencies.
	(cd $PANOPOLY_HOME && phing setup-all)
	(cd $PANOPOLY_HOME && phing install)
fi

# If we are in desktop mode, then we start a couple default applications!
if [ -n "$DISPLAY" ]; then
	# TODO: Detect if PHPStorm is installed. If not, download the installer
	#       and run it. IF so, just start PHPStorm.

	# TODO: Open a web-browser pointing at the local Panopoly site.

	# TODO: Open a web-browser pointing at the sprint document.
	true
fi

