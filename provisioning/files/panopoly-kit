#!/usr/bin/env bash

echo "Welcome to the Panopoly Sprint Kit"

PANOPOLY_HOME=$HOME/Desktop/panopoly

# Setup Panopoly source code.
if ! [ -d "$PANOPOLY_HOME" ]; then
	git clone --branch 7.x-1.x http://git.drupal.org/project/panopoly.git $PANOPOLY_HOME

	# Create build.properties.
	cat > $PANOPOLY_HOME/build.properties << "EOF"
# Automatically generated by 'panopoly-kit'
build.mode = dev
build.core.dir = /var/www/panopoly-kit
drush.site-install.db_url = mysqli://panopoly:panopoly@localhost/panopoly
test.behat.base_url = http://default.panopoly-kit.dev/
EOF

	# Install all our build dependencies with composer.
	ln -s $PANOPOLY_HOME/composer.json $HOME/
	ln -s $PANOPOLY_HOME/composer.lock $HOME/
	composer install -d $HOME

	# Build, get all dependencies, install and run a single test.
	(cd $PANOPOLY_HOME && phing setup-all)
	(cd $PANOPOLY_HOME && phing install)
	(cd $PANOPOLY_HOME && phing test -Dtest.behat.args=features/text_widget.feature)
fi

# Just in case, we change the permissions on /var/www/panopoly-kit.
sudo chown -R panopoly:www-data /var/www/panopoly-kit
sudo find /var/www/panopoly-kit -type d -exec chmod g+wrs \{\} \;

# If we are in desktop mode, then we start a couple default applications!
if [ -n "$DISPLAY" ]; then
	# TODO: Detect if PHPStorm is installed. If not, download the installer
	#       and run it. IF so, just start PHPStorm.

	# TODO: Open a web-browser pointing at the local Panopoly site.

	# TODO: Open a web-browser pointing at the sprint document.
	true
fi

